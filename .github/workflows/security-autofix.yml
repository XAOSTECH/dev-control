name: Security Auto-Fix Bot

on:
  # Trigger on CodeQL scan completion
  workflow_run:
    workflows: ["CodeQL Advanced Security"]
    types:
      - completed
  
  # Manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: read

jobs:
  autofix:
    name: Auto-fix Security Alerts
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run && github.event.workflow_run.conclusion == 'success') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate security app token
        id: app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.XSS_AI }}
          private-key: ${{ secrets.XSS_PK }}
          permission-actions: read
          permission-security-events: read
          permission-workflows: write
          permission-contents: write
          permission-pull-requests: write

      - name: Fetch and analyze CodeQL alerts
        id: alerts
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          # Fetch open security alerts
          ALERTS=$(gh api repos/${{ github.repository }}/code-scanning/alerts?state=open \
            --jq '[.[] | select(.rule.severity == "error" or .rule.severity == "warning") | {
              number: .number,
              rule: .rule.id,
              severity: .rule.severity,
              file: .most_recent_instance.location.path,
              line: .most_recent_instance.location.start_line,
              message: .most_recent_instance.message.text
            }]')
          
          echo "Found $(echo "$ALERTS" | jq 'length') open alerts"
          
          # Count fixable and unfixable alerts
          FIXABLE_COUNT=$(echo "$ALERTS" | jq '[.[] | select(.rule == "actions/code-injection/medium" or .rule == "actions/unpinned-tag")] | length')
          TOTAL_COUNT=$(echo "$ALERTS" | jq 'length')
          UNFIXABLE_COUNT=$((TOTAL_COUNT - FIXABLE_COUNT))
          
          echo "fixable_count=$FIXABLE_COUNT" >> "$GITHUB_OUTPUT"
          echo "unfixable_count=$UNFIXABLE_COUNT" >> "$GITHUB_OUTPUT"
          echo "$ALERTS" > /tmp/alerts.json
          
          if [ "$FIXABLE_COUNT" -eq 0 ]; then
            echo "No auto-fixable alerts found"
            exit 0
          fi

      - name: Apply automatic fixes
        if: steps.alerts.outputs.fixable_count > 0
        id: fixes
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          chmod +x scripts/security-autofix.sh
          scripts/security-autofix.sh "${{ github.repository }}" "$GH_TOKEN" /tmp/alerts.json > /tmp/fixes_output.txt 2>&1
          cat /tmp/fixes_output.txt
          
          # Export modified files
          MODIFIED=$(git diff --name-only || true)
          echo "modified_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$MODIFIED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          
          echo "fixes_applied=$(git diff --name-only | wc -l)" >> "$GITHUB_OUTPUT"

      - name: Create security fix PR
        if: steps.fixes.outputs.fixes_applied > 0 || steps.fixes.outputs.code_injection_found == 'true'
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          BRANCH="security/autofix-$(date +%s)"
          REPO="${{ github.repository }}"
          
          # Get the latest commit SHA from main
          MAIN_SHA=$(gh api "/repos/$REPO/git/ref/heads/main" --jq '.object.sha')
          echo "Main branch SHA: $MAIN_SHA"
          
          # Create blobs for modified files and build tree JSON using jq
          echo "Creating file blobs..."
          TREE_JSON="[]"

          if [[ -z "${{ steps.fixes.outputs.modified_files }}" ]]; then
            echo "No files were modified. Skipping PR creation."
            exit 0
          fi
          
          for file in $(echo "${{ steps.fixes.outputs.modified_files }}" | xargs -n1 | sort -u); do
            if [[ -f "$file" ]]; then
              echo "  ðŸ“ Processing $file"
              # Create blob via API
              BLOB_SHA=$(gh api "/repos/$REPO/git/blobs" \
                -X POST \
                -f content="$(cat "$file")" \
                -f encoding="utf-8" \
                --jq '.sha')
              
              # Add to tree array using jq for proper JSON construction
              TREE_JSON=$(echo "$TREE_JSON" | jq --arg path "$file" --arg sha "$BLOB_SHA" \
                '. += [{"path": $path, "mode": "100644", "type": "blob", "sha": $sha}]')
            fi
          done
          
          echo "Tree JSON built with $(echo "$TREE_JSON" | jq 'length') items"
          echo "Tree JSON sample: $(echo "$TREE_JSON" | jq '.[0]' 2>/dev/null || echo 'empty')"
          
          # Get the base tree SHA
          BASE_TREE=$(gh api "/repos/$REPO/git/commits/$MAIN_SHA" --jq '.tree.sha')
          echo "Base tree: $BASE_TREE"
          
          # Create new tree
          echo "Creating git tree..."
          # GitHub API expects: POST /repos/{owner}/{repo}/git/trees
          # Body: {base_tree: SHA, tree: [{path: string, mode: string, type: string, sha: string}]}
          TREE_PAYLOAD=$(jq -n --arg base_tree "$BASE_TREE" --argjson tree "$TREE_JSON" \
            '{base_tree: $base_tree, tree: $tree}')
          if ! TREE_SHA=$(printf '%s' "$TREE_PAYLOAD" | gh api "/repos/$REPO/git/trees" -X POST --input - --jq '.sha'); then
            echo "Tree creation failed. Debug info:"
            echo "BASE_TREE=$BASE_TREE"
            echo "TREE_JSON=$TREE_JSON"
            echo "TREE_PAYLOAD=$TREE_PAYLOAD"
            exit 1
          fi
          echo "New tree SHA: $TREE_SHA"
          
          # Create commit
          echo "Creating commit..."
          COMMIT_PAYLOAD=$(jq -n \
            --arg message "security: auto-fix CodeQL alerts" \
            --arg tree "$TREE_SHA" \
            --arg parent "$MAIN_SHA" \
            '{message: $message, tree: $tree, parents: [$parent]}')
          if ! COMMIT_SHA=$(printf '%s' "$COMMIT_PAYLOAD" | gh api "/repos/$REPO/git/commits" -X POST --input - --jq '.sha'); then
            echo "Commit creation failed. Debug info:"
            echo "COMMIT_PAYLOAD=$COMMIT_PAYLOAD"
            exit 1
          fi
          echo "Commit SHA: $COMMIT_SHA"
          
          # Create branch reference
          echo "Creating branch $BRANCH..."
          gh api "/repos/$REPO/git/refs" \
            -X POST \
            -f ref="refs/heads/$BRANCH" \
            -f sha="$COMMIT_SHA"
          
          # Create PR - write body to temp file
          echo "Automated Security Fixes" > /tmp/pr_body.md
          echo "========================" >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "This PR contains automatic fixes for security alerts detected by CodeQL." >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "Alerts Addressed:" >> /tmp/pr_body.md
          cat /tmp/alerts.json | jq -r '.[] | "- [\(.severity | ascii_upcase)] \(.rule): \(.file):\(.line)"' >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "Changes Made:" >> /tmp/pr_body.md
          echo "- Extract GitHub Actions context variables to environment variables" >> /tmp/pr_body.md
          echo "- Pin unpinned third-party actions to commit SHAs" >> /tmp/pr_body.md
          echo "- Quote shell variables to prevent code injection" >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "Verification Needed:" >> /tmp/pr_body.md
          echo "Review required - validate that fixes don't break workflow functionality" >> /tmp/pr_body.md
          echo "" >> /tmp/pr_body.md
          echo "---" >> /tmp/pr_body.md
          echo "Auto-generated by security-autofix workflow" >> /tmp/pr_body.md
          
          # Ensure labels exist before creating PR
          gh label create security --color D73A4A --description "Security-related changes" --force || true
          gh label create automated --color 0E8A16 --description "Automated changes" --force || true
          gh label create automerge --color 32BF6F --description "Auto-merge this PR" --force || true

          gh pr create \
            --repo "$REPO" \
            --base main \
            --head "$BRANCH" \
            --title "ðŸ”’ Security Auto-Fix: CodeQL Alerts" \
            --body-file /tmp/pr_body.md \
            --label security,automated,automerge

      - name: Create GitHub Issue for manual review
        if: steps.alerts.outputs.unfixable_count > 0
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          # Check if a recent issue with this exact alert set already exists
          # Use a hash of the unfixable alerts as a unique identifier
          ALERT_HASH=$(jq -r '[.[] | select(.rule != "actions/code-injection/medium" and .rule != "actions/unpinned-tag") | .number] | sort | @csv' /tmp/alerts.json | md5sum | cut -d' ' -f1)
          
          EXISTING=$(gh issue list --state open --label security-review --json number,body --jq ".[] | select(.body | contains(\"Alert hash: ${ALERT_HASH}\")) | .number" 2>/dev/null | head -1)
          
          if [ -n "$EXISTING" ]; then
            echo "â„¹ï¸  Similar security review issue #${EXISTING} already exists, skipping duplicate"
            exit 0
          fi
          
          # Create tracking issue - write body to temp file
          echo "Security Alerts Requiring Manual Review" > /tmp/issue_body.md
          echo "=========================================" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "The following CodeQL alerts cannot be automatically fixed and require manual intervention:" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          # Filter to only unfixable alerts (exclude code-injection/medium and unpinned-tag)
          jq -r '.[] | select(.rule != "actions/code-injection/medium" and .rule != "actions/unpinned-tag") | "### Alert #\(.number): \(.rule)\n- **Severity**: \(.severity)\n- **File**: `\(.file):\(.line)`\n- **Message**: \(.message)\n"' /tmp/alerts.json >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "---" >> /tmp/issue_body.md
          echo "Alert hash: ${ALERT_HASH}" >> /tmp/issue_body.md
          echo "Auto-generated by security-autofix workflow" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "### Recommended Actions" >> /tmp/issue_body.md
          echo "1. Review each alert in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> /tmp/issue_body.md
          echo "2. Apply fixes following GitHub Security Lab recommendations" >> /tmp/issue_body.md
          echo "3. Close alerts as fixed or false positive in dashboard" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "---" >> /tmp/issue_body.md
          echo "Auto-generated by security-autofix workflow" >> /tmp/issue_body.md
          
          gh issue create \
            --title "ðŸ”’ Security Review: CodeQL Alerts Require Manual Fixes" \
            --label security-review,help-wanted \
            --body-file /tmp/issue_body.md
