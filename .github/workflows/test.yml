name: Tests

on:
  push:
    branches: [Main, develop]
  pull_request:
    branches: [Main]

permissions:
  contents: read
  checks: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      
      - name: Install bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats
          git clone --depth 1 https://github.com/bats-core/bats-support.git tests/test_helper/bats-support
          git clone --depth 1 https://github.com/bats-core/bats-assert.git tests/test_helper/bats-assert
      
      - name: Run tests
        run: |
          chmod +x ./tests/run_tests.sh
          ./tests/run_tests.sh
      
      - name: Shellcheck
        run: |
          sudo apt-get install -y shellcheck
          shellcheck scripts/*.sh scripts/lib/*.sh
        continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      
      - name: Shellcheck
        run: |
          # Use shellcheck with our custom .shellcheckrc config
          shellcheck --severity=warning scripts/**/*.sh