# ============================================================================
# Reusable Template Loading Workflow (central-loader.yml)
# ============================================================================
#
# This is a reusable workflow that can be called from other repositories.
# It loads templates from all *-templates folders in Dev-Control:
#   - docs-templates/     â†’ copied to repo root (with placeholder replacement)
#   - workflows-templates/ â†’ copied to .github/workflows/
#   - licenses-templates/  â†’ copied to repo root (future)
#   - Any other *-templates folders added later
#
# USAGE (from another repo):
#
#   jobs:
#     init-templates:
#       uses: xaoscience/dev-control/.github/workflows/central-loader.yml@main
#       with:
#         project_name: 'My Project'
#         short_description: 'A cool project'
#         license_type: 'MIT'
#         stability: 'experimental'
#         templates: 'all'
#
# NOTE: The calling repository must have:
#   - permissions: contents: write, pull-requests: write
#
# ============================================================================

name: Template Loader (Reusable)

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Project name (default: repo name)'
        required: false
        type: string
        default: ''
      short_description:
        description: 'Short project description'
        required: false
        type: string
        default: 'A project powered by Dev-Control templates'
      license_type:
        description: 'License type (MIT, Apache-2.0, GPL-3.0, BSD-3-Clause)'
        required: false
        type: string
        default: 'MIT'
      stability:
        description: 'Stability level (experimental, beta, stable, mature)'
        required: false
        type: string
        default: 'experimental'
      templates:
        description: 'Templates to install (readme,contributing,conduct,security,all)'
        required: false
        type: string
        default: 'all'
      create_pr:
        description: 'Create a PR instead of direct commit'
        required: false
        type: boolean
        default: true
    outputs:
      pr_number:
        description: 'The PR number if a PR was created'
        value: ${{ jobs.load-templates.outputs.pr_number }}
      templates_installed:
        description: 'List of templates that were installed'
        value: ${{ jobs.load-templates.outputs.templates_installed }}

jobs:
  load-templates:
    name: Load Templates
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}
      templates_installed: ${{ steps.process.outputs.installed }}
    
    steps:
      - name: Checkout calling repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Checkout Dev-Control templates
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          repository: xaoscience/dev-control
          path: .dev-control-templates
          sparse-checkout: |
            docs-templates
            workflows-templates
            licenses-templates
          sparse-checkout-cone-mode: false
      
      - name: Set up variables
        id: vars
        env:
          REPO_NAME_INPUT: ${{ github.event.repository.name }}
          REPO_OWNER_INPUT: ${{ github.repository_owner }}
          REPO_FULL: ${{ github.repository }}
          PROJECT_NAME_INPUT: ${{ inputs.project_name }}
          STABILITY_INPUT: ${{ inputs.stability }}
          FIX_STEPS_VARS_OUTPUTS_CURRENT_Y: ${{ steps.vars.outputs.current_year }}
          FIX_STEPS_VARS_OUTPUTS_STABILITY: ${{ steps.vars.outputs.stability_color }}
          FIX_INPUTS_LICENSE_TYPE: ${{ inputs.license_type }}
          FIX_INPUTS_SHORT_DESCRIPTION: ${{ inputs.short_description }}
          FIX_STEPS_VARS_OUTPUTS_REPO_URL: ${{ steps.vars.outputs.repo_url }}
          FIX_STEPS_VARS_OUTPUTS_REPO_OWNE: ${{ steps.vars.outputs.repo_owner }}
          FIX_STEPS_VARS_OUTPUTS_REPO_NAME: ${{ steps.vars.outputs.repo_name }}
          FIX_STEPS_VARS_OUTPUTS_PROJECT_N: ${{ steps.vars.outputs.project_name }}
          FIX_INPUTS_TEMPLATES: ${{ inputs.templates }}
        run: |
          # Repository info from calling repo
          echo "repo_name=$REPO_NAME_INPUT" >> "$GITHUB_OUTPUT"
          echo "repo_owner=$REPO_OWNER_INPUT" >> "$GITHUB_OUTPUT"
          echo "repo_url=https://github.com/$REPO_FULL" >> "$GITHUB_OUTPUT"
          
          # Project name
          PROJECT_NAME="$PROJECT_NAME_INPUT"
          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="$REPO_NAME_INPUT"
          fi
          echo "project_name=$PROJECT_NAME" >> "$GITHUB_OUTPUT"
          
          # Stability color
          case "$STABILITY_INPUT" in
            experimental) echo "stability_color=orange" >> "$GITHUB_OUTPUT" ;;
            beta) echo "stability_color=yellow" >> "$GITHUB_OUTPUT" ;;
            stable) echo "stability_color=green" >> "$GITHUB_OUTPUT" ;;
            mature) echo "stability_color=blue" >> "$GITHUB_OUTPUT" ;;
            *) echo "stability_color=orange" >> "$GITHUB_OUTPUT" ;;
          esac
          
          echo "current_year=$(date +%Y)" >> "$GITHUB_OUTPUT"
          echo "branch_name=chore/init-templates-$(date +%Y%m%d%H%M%S)" >> "$GITHUB_OUTPUT"
      
      - name: Process and copy templates
        id: process
        env:
          PROJECT_NAME: ${{ steps.vars.outputs.project_name }}
          REPO_SLUG: ${{ steps.vars.outputs.repo_name }}
          ORG_NAME: ${{ steps.vars.outputs.repo_owner }}
          REPO_URL: ${{ steps.vars.outputs.repo_url }}
          SHORT_DESC: ${{ inputs.short_description }}
          LICENSE_TYPE: ${{ inputs.license_type }}
          STABILITY: ${{ inputs.stability }}
          STABILITY_COLOR: ${{ steps.vars.outputs.stability_color }}
          CURRENT_YEAR: ${{ steps.vars.outputs.current_year }}
          FIX_INPUTS_TEMPLATES: $FIX_INPUTS_TEMPLATES
        run: |
          TEMPLATES="$FIX_INPUTS_TEMPLATES"
          DC_DIR=".dev-control-templates"
          INSTALLED=""
          
          # Function to process a file with placeholder replacement
          # Variables are extracted as environment variables to prevent code injection
          process_file() {
            local src="$1"
            local dest="$2"
            sed \
              -e "s|{{PROJECT_NAME}}|$PROJECT_NAME|g" \
              -e "s|{{REPO_SLUG}}|$REPO_SLUG|g" \
              -e "s|{{ORG_NAME}}|$ORG_NAME|g" \
              -e "s|{{REPO_URL}}|$REPO_URL|g" \
              -e "s|{{SHORT_DESCRIPTION}}|$SHORT_DESC|g" \
              -e "s|{{LONG_DESCRIPTION}}|$SHORT_DESC|g" \
              -e "s|{{LICENSE_TYPE}}|$LICENSE_TYPE|g" \
              -e "s|{{STABILITY}}|$STABILITY|g" \
              -e "s|{{STABILITY_COLOR}}|$STABILITY_COLOR|g" \
              -e "s|{{CURRENT_YEAR}}|$CURRENT_YEAR|g" \
              "$src" > "$dest"
          }
          
          # Process docs-templates (to repo root)
          if [[ -d "$DC_DIR/docs-templates" ]]; then
            echo "ðŸ“„ Processing docs-templates..."
            if [[ "$TEMPLATES" == "all" ]]; then
              DOC_TEMPLATES="readme,contributing,conduct,security"
            else
              DOC_TEMPLATES="$TEMPLATES"
            fi
            
            IFS=',' read -ra TEMPLATE_LIST <<< "$DOC_TEMPLATES"
            for template in "${TEMPLATE_LIST[@]}"; do
              template=$(echo "$template" | tr -d ' ' | tr '[:upper:]' '[:lower:]')
              case "$template" in
                readme) SRC="$DC_DIR/docs-templates/README.md"; DEST="README.md" ;;
                contributing) SRC="$DC_DIR/docs-templates/CONTRIBUTING.md"; DEST="CONTRIBUTING.md" ;;
                conduct|code_of_conduct) SRC="$DC_DIR/docs-templates/CODE_OF_CONDUCT.md"; DEST="CODE_OF_CONDUCT.md" ;;
                security) SRC="$DC_DIR/docs-templates/SECURITY.md"; DEST="SECURITY.md" ;;
                *) continue ;;
              esac
              if [ -f "$SRC" ]; then
                process_file "$SRC" "$DEST"
                echo "âœ“ Created $DEST"
                INSTALLED="$INSTALLED$DEST,"
              fi
            done
          fi
          
          # Process workflows-templates (to .github/workflows/)
          if [[ -d "$DC_DIR/workflows-templates" ]] && [[ "$TEMPLATES" == "all" || "$TEMPLATES" == *"workflows"* ]]; then
            echo "âš™ï¸ Processing workflows-templates..."
            mkdir -p .github/workflows
            for wf in "$DC_DIR/workflows-templates"/*.yml; do
              if [ -f "$wf" ]; then
                wf_name=$(basename "$wf")
                # Skip init.yml and remote-init.yml (those are for copying manually)
                if [[ "$wf_name" != "init.yml" && "$wf_name" != "remote-init.yml" ]]; then
                  cp "$wf" ".github/workflows/$wf_name"
                  echo "âœ“ Created .github/workflows/$wf_name"
                  INSTALLED="$INSTALLED.github/workflows/$wf_name,"
                fi
              fi
            done
          fi
          
          # Process licenses-templates (to repo root, direct copy)
          if [[ -d "$DC_DIR/licenses-templates" ]] && [[ "$TEMPLATES" == "all" || "$TEMPLATES" == *"license"* ]]; then
            echo "ðŸ“œ Processing licenses-templates..."
            for lic in "$DC_DIR/licenses-templates"/*; do
              if [ -f "$lic" ]; then
                lic_name=$(basename "$lic")
                process_file "$lic" "$lic_name"
                echo "âœ“ Created $lic_name"
                INSTALLED="$INSTALLED$lic_name,"
              fi
            done
          fi
          
          # Process any other *-templates folders (future expansion)
          for tpl_dir in "$DC_DIR"/*-templates; do
            if [ -d "$tpl_dir" ]; then
              dir_name=$(basename "$tpl_dir")
              # Skip already processed
              if [[ "$dir_name" == "docs-templates" || "$dir_name" == "workflows-templates" || "$dir_name" == "licenses-templates" ]]; then
                continue
              fi
              echo "ðŸ“¦ Processing $dir_name..."
              for file in "$tpl_dir"/*; do
                if [ -f "$file" ]; then
                  fname=$(basename "$file")
                  process_file "$file" "$fname"
                  echo "âœ“ Created $fname"
                  INSTALLED="$INSTALLED$fname,"
                fi
              done
            fi
          done
          
          # Cleanup
          rm -rf .dev-control-templates
          
          echo "installed=${INSTALLED%,}" >> "$GITHUB_OUTPUT"
      
      - name: Create Pull Request
        id: create-pr
        if: ${{ inputs.create_pr }}
        uses: peter-evans/create-pull-request@5b4a9f6a9e2af4d592344f7a3e1c8b0e7c1e1e1e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: initialise repository templates via Dev-Control'
          title: 'ðŸ“š Initialise repository documentation'
          body: |
            ## Summary
            
            This PR adds standardised documentation templates.
            
            ### Templates Added
            ${{ steps.process.outputs.installed }}
            
            ### Configuration
            | Setting | Value |
            |---------|-------|
            | Project Name | `$FIX_STEPS_VARS_OUTPUTS_PROJECT_N` |
            | License | `$FIX_INPUTS_LICENSE_TYPE` |
            | Stability | `$FIX_INPUTS_STABILITY` |
            
            ---
            *Generated by Dev-Control reusable workflow*
          branch: ${{ steps.vars.outputs.branch_name }}
          delete-branch: true
          labels: |
            documentation
            automated
      
      - name: Import GPG key (if available)
        id: import_gpg
        if: ${{ !inputs.create_pr }}
        continue-on-error: true
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [[ -z "$GPG_PRIVATE_KEY" ]]; then
            echo "â„¹ï¸ GPG_PRIVATE_KEY not configured - commits will be unsigned"
            echo "outcome=skipped" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # Import the key
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import 2>&1 | sed -E 's/key [0-9A-F]+: //' || true
          
          # Get the key ID (try multiple patterns)
          KEY_ID=$(echo "$GPG_PRIVATE_KEY" | gpg --batch --import --import-options show-only 2>&1 | grep -oE 'key [0-9A-F]+' | head -1 | awk '{print $2}' || true)
          
          if [[ -z "$KEY_ID" ]]; then
            KEY_ID=$(gpg --list-secret-keys --keyid-format=long 2>/dev/null | grep -oE '[0-9A-F]{16}' | head -1 || true)
          fi
          
          if [[ -z "$KEY_ID" ]]; then
            echo "âš ï¸ Could not extract GPG key ID, but import may have succeeded"
            echo "â„¹ï¸ Commits will be unsigned"
            echo "outcome=partial" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          git config --global user.signingkey "$KEY_ID"
          git config --global commit.gpgsign true
          
          echo "âœ… GPG key imported and configured successfully"
          echo "outcome=success" >> "$GITHUB_OUTPUT"
          exit 0
      
      - name: Direct commit
        if: ${{ !inputs.create_pr }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add *.md 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: initialise repository templates via Dev-Control"
            git push
          fi